<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
  	<div class="mixpanel-platform-section">
  		<div style="display:flex;justify-content:center;align-items:center;width:100%;">Most Common User Flows</div>
  		<div style="clear: both;"></div>
  	</div>
  	<div class="mixpanel-platform-section">
      <div id="dateSelect" style="float: left;"></div>
      <div id="unitSelect" style="float: right;"></div>
      <div id="timeSelect" style="float: right;"></div>
      <div id="sessionlength" style="float: right;">Session Length:</div>
      <div style="clear: both;"></div>
    </div>
    <div class="mixpanel-platform-section">
      <div style="float: left">Minimum sequence length:</div>
      <div id="minLengthSelect" style="float: left;"></div>
      <div style="float: left">Number of results to show:</div>
      <div id="numResultsSelect" style="float: left;"></div>
      <div style="float: left">Sampling percentage:</div>
      <div id="samplingSelect" style="float: left;"></div>
      <div style="clear: both;"></div>
    </div>
    <div id="table"></div>
    <script>
      var script = 'function main(){return Events({from_date:params.from_date,to_date:params.to_date}).filter(function(e){return e.distinct_id.hashCode()%1e3<10*params.sampling_factor}).groupByUser(function(e,t){e=e||{sequence_list:[""],num_events_list:[0],start_time:t[0].time,sequence_index:0};for(var n=0;n<t.length;n++)t[n].time-params.conversion_length<=e.start_time?(e.sequence_list[e.sequence_index]+=t[n].name+", ",e.num_events_list[e.sequence_index]++):(e.start_time=t[n].time,e.sequence_index++,e.sequence_list.push(t[n].name+", "),e.num_events_list.push(1));return e}).map(function(e){for(var t="",n=0,s=0;s<e.value.num_events_list.length;s++)e.value.num_events_list[s]>n&&(t=e.value.sequence_list[s],n=e.value.num_events_list[s]);return{sequence:t.slice(0,-2),count:n}}).filter(function(e){return e.count>=params.event_count}).groupBy([function(e){return e.sequence}],mixpanel.reducer.count()).reduce(mixpanel.reducer.top(params.num_results))}String.prototype.hashCode=function(){for(var e=0,t=0,n=this.length;n>t;)e=(e<<5)-e+this.charCodeAt(t++)<<0;return e+2147483648};';
      var eventTable  = $('#table').MPTable({showPercentages: false, firstColHeader: 'Rank'});
      var dateSelect  = $('#dateSelect').MPDatepicker();
      var time_length = $('#timeSelect').MPSelect({items: [{label: '1', value: 1},{label: '2', value: 2},{label: '3', value: 3},{label: '4', value: 4},{label: '5', value: 5},{label: '6', value: 6},{label: '7', value: 7},{label: '8', value: 8},{label: '9', value: 9},{label: '10', value: 10},{label: '11', value: 11},{label: '12', value: 12},{label: '13', value: 13},{label: '14', value: 14},{label: '15', value: 15},{label: '16', value: 16},{label: '17', value: 17},{label: '18', value: 18},{label: '19', value: 19},{label: '20', value: 20},{label: '21', value: 21},{label: '22', value: 22},{label: '23', value: 23},{label: '24', value: 24},{label: '25', value: 25},{label: '26', value: 26},{label: '27', value: 27},{label: '28', value: 28},{label: '29', value: 29},{label: '30', value: 30},]});
      var time_unit = $('#unitSelect').MPSelect({items: [{label: 'hours', value: 3600000},{label: 'days', value: 86400000},{label: 'weeks', value: 604800000},{label: 'months', value: 2592000000}]});
      time_unit.val(86400000);
      var min_sequence_length = $('#minLengthSelect').MPSelect({items: [{label: '1', value: 1},{label: '2', value: 2},{label: '3', value: 3},{label: '4', value: 4},{label: '5', value: 5}]});
      min_sequence_length.val(2);
      var max_results = $('#numResultsSelect').MPSelect({items: [{label: '5', value: 5},{label: '10', value: 10},{label: '20', value: 20},{label: '50', value: 50},{label: '100', value: 100}]});
      max_results.val(10);
      var sampling_rate = $('#samplingSelect').MPSelect({items: [{label: '100%', value: 100}, {label: '10%', value: 10}, {label: '1%', value: 1}, {label: '.1%', value: .1}]});
      sampling_rate.val(100);
      function runQuery() {
        var from_date = dateSelect.MPDatepicker('value').from.toISOString().slice(0,-14);
        var to_date = dateSelect.MPDatepicker('value').to.toISOString().slice(0,-14);
        var event_count = min_sequence_length.MPSelect('value');
        var conversion_length = time_length.MPSelect('value') * time_unit.MPSelect('value');
        var num_results = max_results.MPSelect('value');
        var sampling_factor = sampling_rate.MPSelect('value');
        var params = {'from_date': from_date,
        			  'to_date': to_date,
        			  'event_count': event_count,
        			  'conversion_length': conversion_length,
        			  'num_results': num_results,
        			  'sampling_factor': sampling_factor};
        MP.api.custom_query(script, params).done(function(results) {
          var res = ['this is a stupid placeholder to delete because MPTable displays the indexes for some reason'];
          if (results.length > 0) {
          	var obj = {};
          	for (var i = 0; i < results[0].length; i++) {
          		obj['Sequence'] = results[0][i].key[0];
          		obj['Count'] = results[0][i].value;
          		if (sampling_factor != 100) {
          			obj['Count (Corrected)'] = obj['Count'] / (sampling_factor / 100);
          		}
          		res.push(obj);
          		obj = {};
          	}
          }
          delete res[0];
          eventTable.MPTable('setData', res);
        });
      }
      runQuery();
      dateSelect.on('change', function () {runQuery()});
      time_length.on('change', function (e, selection) {runQuery()});
      time_unit.on('change', function (e, selection) {runQuery()});
      min_sequence_length.on('change', function (e, selection) {runQuery()});
      max_results.on('change', function (e, selection) {runQuery()});
      sampling_rate.on('change', function (e, selection) {runQuery()});
    </script>
  </body>
</html>